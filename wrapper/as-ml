#! /bin/sh
# Wrapper for compilers which do not understand '-c -o'.

scriptversion=2018-03-07.03; # UTC

# Copyright (C) 1999-2023 Free Software Foundation, Inc.
# Written by Tom Tromey <tromey@cygnus.com>.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# As a special exception to the GNU General Public License, if you
# distribute this file as part of a program that contains a
# configuration script generated by Autoconf, you may include it under
# the same distribution terms that you use for the rest of that program.

# This file is maintained in Automake, please report
# bugs to <bug-automake@gnu.org> or send patches to
# <automake-patches@gnu.org>.

nl='
'

# We need space, tab and new line, in precisely that order.  Quoting is
# there to prevent tools from complaining about whitespace usage.
IFS=" ""	$nl"

file_conv=

# func_file_conv build_file lazy
# Convert a $build file to $host form and store it in $file
# Currently only supports Windows hosts. If the determined conversion
# type is listed in (the comma separated) LAZY, no conversion will
# take place.
func_file_conv ()
{
  file=$1
  case $file in
    / | /[!/]*) # absolute file, and not a UNC file
      if test -z "$file_conv"; then
        # lazily determine how to convert abs files
        case `uname -s` in
          MINGW*)
            file_conv=mingw
            ;;
          CYGWIN* | MSYS*)
            file_conv=cygwin
            ;;
          *)
            file_conv=wine
            ;;
        esac
        fi
      case $file_conv/,$2, in
        *,$file_conv,*)
          ;;
        mingw/*)
          file=`cmd //C echo "$file " | sed -e 's/"\(.*\) " *$/\1/'`
          ;;
        cygwin/* | msys/*)
          file=`cygpath -m "$file" || echo "$file"`
          ;;
        wine/*)
          file=`winepath -w "$file" || echo "$file"`
          ;;
        esac
      ;;
  esac
}

# func_ml_wrapper cl arg...
# Adjust compile command to suit cl
func_ml_wrapper ()
{
  sfile=
  asmfile=
  defines=
  includes=
  outdir=
  for arg
  do
    if test -n "$eat"; then
      eat=
    else
      case $1 in
        -o)
          # configure might choose to run compile as 'compile cc -o foo foo.c'.
          eat=1
          outdir="$(dirname $2)"
          case $2 in
            *.o | *.[oO][bB][jJ])
              func_file_conv "$2"
              set x "$@" -Fo"$file"
              ;;
            *)
              func_file_conv "$2"
              set x "$@" -Fe"$file"
              ;;
          esac
          shift
          ;;
        *.asm | *.OBJ | *.obj | *.[oO])
          func_file_conv "$1" mingw
          set x "$@" "$file"
          shift
          ;;
        -D* | -D*=*)
          defines="$defines $1"
          ;;
        -I)
          eat=1
          func_file_conv "$2" mingw
          includes="$includes -I$file"
          ;;
        -I*)
          func_file_conv "${1#-I}" mingw
          includes="$includes -I$file"
          ;;
        *.S)
          func_file_conv "$1"
          sfile=$file
          ;;
        *)
          set x "$@" "$1"
          shift
          ;;
      esac
    fi
    shift
  done
  if test -n "$sfile"; then
    asmfile="$outdir/$(basename $sfile|sed 's/.S$/.asm/g')"
    eval "cl -nologo -EP $includes $defines $sfile" > $asmfile
  fi
  exec "$@" $asmfile
  exit 1
}

eat=

case $1 in
  '')
     echo "$0: No command.  Try '$0 --help' for more information." 1>&2
     exit 1;
     ;;
  -h | --h*)
    cat <<\EOF
Usage: as-ml [--help] [--version] PROGRAM [ARGS]

Wrapper for compilers which do not understand '-c -o'.
Remove '-o dest.o' from ARGS, run PROGRAM with the remaining
arguments, and rename the output as expected.

If you are trying to build a whole package this is not the
right script to run: please start by reading the file 'INSTALL'.

Report bugs to <bug-automake@gnu.org>.
EOF
    exit $?
    ;;
  -v | --v*)
    echo "as-ml $scriptversion"
    exit $?
    ;;
  ml | *[/\\]ml | ml.exe | *[/\\]ml.exe | \
    ml64 | *[/\\]ml64 | ml64.exe | *[/\\]ml64.exe )
    func_ml_wrapper "$@"      # Doesn't return...
    ;;
esac

# Local Variables:
# mode: shell-script
# sh-indentation: 2
# eval: (add-hook 'before-save-hook 'time-stamp)
# time-stamp-start: "scriptversion="
# time-stamp-format: "%:y-%02m-%02d.%02H"
# time-stamp-time-zone: "UTC0"
# time-stamp-end: "; # UTC"
# End:
